<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--
====================================================================
index_17.html â€” æ¯æ—¥é¤é»çµ„åˆï¼ˆå…¨é å¸é™„å‘ˆç¾ç‰ˆï¼‰
--------------------------------------------------------------------
*å°‡å€‹äººåŒ–å•å·ä¸²ä¸Šé£Ÿç‰©æ¨è–¦ç³»çµ±
meal_recommendation_3.html + index_17.html + server_10.js v

ã€è³‡æ–™ä¾†æºã€‘
- é¤é»ç¢ç‰‡ï¼šfood_fragments.json
- æ¨è–¦é‚è¼¯ï¼šserver_10.js
- APIï¼šPOST /recommend

- ç¶²é ï¼šhttp://localhost:3000/meal_recommendation_3.html
http://localhost:3000/recommend/outside
====================================================================
-->

<title>æº«é¦¨ç¾å‘³çš„ä¸€é¤</title>

<style>
/* ======================================================
æº«é¦¨é…è‰²è®Šæ•¸ï¼ˆæ•´ç«™æƒ…ç·’åŸºæº–ï¼‰
====================================================== */
:root {
--bg-warm: #f6f3ee;
--bg-soft: #fbfaf7;
--card-bg: #ffffff;

--green-main: #3a7f68;
--green-soft: #6b9c8b;

--text-main: #2f2f2f;
--text-muted: #7a7a7a;

--tag-bg: #e8f2ee;
}

/* ======================================================
åŸºç¤è¨­å®š
====================================================== */
body {
margin: 0;
font-family: system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei";
background: var(--bg-warm);
color: var(--text-main);
}

.wrap {
max-width: 720px;
margin: 0 auto;
}

/* ======================================================
ä¸Šæ–¹æº«é¦¨ Header
====================================================== */
.header {
height: 160px;
padding: 20px 16px;
background: linear-gradient(180deg, #f4efe7, #f9f7f3);
}

h1 {
margin: 0 0 10px;
color: var(--green-main);
font-size: 22px;
}

.muted {
color: var(--green-soft);
font-size: 14px;
line-height: 1.5;
}


/* ======================================================
Loading å‹•ç•«
====================================================== */
.loading-screen {
  position: fixed;
  inset: 0;
  background: #fbfaf7;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.loading-card {
  text-align: center;
  padding: 24px 28px;
  background: #ffffff;
  border-radius: 18px;
  box-shadow: 0 10px 24px rgba(0,0,0,0.08);
  color: #3a7f68;
  font-size: 15px;
}

.spinner {
  width: 36px;
  height: 36px;
  border: 4px solid #e8f2ee;
  border-top-color: #3a7f68;
  border-radius: 50%;
  margin: 0 auto 14px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}


/* ======================================================
æ»‘å‹•å€ï¼ˆå…¨é å¸é™„ï¼‰
====================================================== */
#results {
height: calc(100vh - 160px);
overflow-y: scroll;
scroll-snap-type: y mandatory;
background: var(--bg-soft);
}

/* ======================================================
æ¨è–¦å¡ç‰‡ï¼ˆä¸€çµ„ï¼ä¸€é ï¼‰
====================================================== */
.combo-card {
min-height: calc(100vh - 160px);
scroll-snap-align: start;

display: flex;
flex-direction: column;
padding: 28px 22px;
background: var(--card-bg);
border-radius: 18px;
margin: 16px;
box-shadow: 0 10px 24px rgba(0,0,0,0.04);
}

.combo-body {
flex: 1;
}

/* ======================================================
æ¨™é¡Œæ–‡å­—
====================================================== */
.combo-title {
font-size: 20px;
font-weight: 700;
margin: 0;
color: var(--green-main);
}

.combo-subtitle {
margin: 6px 0 14px;
color: var(--green-soft);
font-size: 14px;
}

/* ======================================================
é¤é»æ¸…å–®ï¼ˆæ–‡å­—å…ˆæ–¼åœ–ç‰‡ï¼Œå»ºç«‹å®‰å…¨æ„Ÿï¼‰
====================================================== */
ul {
padding-left: 18px;
margin: 0 0 10px;
}

li {
margin-bottom: 6px;
color: var(--text-main);
}

/* ======================================================
é¤é»åœ–ç‰‡ï¼ˆè¼”åŠ©æƒ³åƒï¼Œä¸ä¸»å°ï¼‰
====================================================== */
.food-images {
display: flex;
gap: 10px;
margin: 14px 0 18px;
}

.food-images img {
width: 48%;
height: 110px;
border-radius: 14px;
object-fit: cover;
background: #eee;
}

/* ======================================================
ç‡Ÿé¤Šæ¨™ç±¤ï¼ˆä½å£“åŠ›å‘ˆç¾ï¼‰
====================================================== */
.tags span {
display: inline-block;
background: var(--tag-bg);
color: var(--green-main);
padding: 5px 10px;
border-radius: 999px;
margin-right: 6px;
font-size: 12px;
}

/* ======================================================
åº•éƒ¨è³‡è¨Š
====================================================== */
.combo-meta {
font-size: 13px;
color: var(--text-muted);
margin-top: 14px;
}

.end-note {
margin-top: auto;
text-align: center;
color: var(--text-muted);
font-size: 14px;
padding-top: 24px;
}
</style>
</head>

<body>
<div class="wrap">

  <!-- ä¸Šæ–¹æº«é¦¨å€ -->
  <div class="header">
    <h1>æº«é¦¨ç¾å‘³çš„ä¸€é¤</h1>
    <p class="muted">
      ä»Šå¤©å°±é€™æ¨£åƒå§ğŸŒ¿
    </p>
  </div>

  <!-- âœ… Loading ç•«é¢ï¼ˆå°±æ”¾é€™è£¡ï¼‰ -->
  <div id="loading" class="loading-screen">
    <div class="loading-card">
      <div class="spinner"></div>
      <p>æ­£åœ¨ç‚ºä½ æŒ‘é¸é™„è¿‘é©åˆçš„é¤å»³ ğŸ±</p>
    </div>
  </div>

  <!-- æ¨è–¦çµæœ -->
  <div id="results"></div>

</div>

<script>

// å–å¾—ç”¨æˆ¶ç•¶å‰ä½ç½®
function getUserLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject("Geolocation not supported");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        resolve({
          lat: pos.coords.latitude,
          lon: pos.coords.longitude
        });
      },
      (err) => {
        reject(err.message);
      },
      {
        enableHighAccuracy: false, // å¤–é£Ÿæ¨è–¦ä¸éœ€è¦ GPS ç´š
        timeout: 10000,
        maximumAge: 60000
      }
    );
  });
}

console.log("ğŸš€ loadRecommendations start");
async function loadRecommendations() {
  const loadingEl = document.getElementById("loading");
  const resultsEl = document.getElementById("results");

  loadingEl.style.display = "block";
  await new Promise(r => requestAnimationFrame(r));


  try {
    let location;
    try{
      location = await getUserLocation();
      console.log("ğŸ“ ä½¿ç”¨è€…å®šä½ï¼š", location);
    }catch (err) {
    console.warn("âš ï¸ å®šä½å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä½ç½®", err);
      location = {
        lat: 25.0173,
        lon: 121.5397
      };
    }

    const res = await fetch(
      `/recommend/outside/osm?lat=${location.lat}&lon=${location.lon}`
    );

    const data = await res.json();

    // âœ… æˆåŠŸæ‰é—œ loading
    loadingEl.style.display = "none";
    resultsEl.innerHTML = "";

    if (!data || !Array.isArray(data.restaurants)) {
      console.warn("âš ï¸ æ¨è–¦è³‡æ–™å°šæœªæº–å‚™å¥½", data);
      loadingEl.querySelector("p").textContent =
        "æ­£åœ¨ç‚ºä½ æ•´ç†æ¨è–¦ï¼Œè«‹ç¨å€™ä¸€ä¸‹ ğŸƒ";
      return;
    }

    data.restaurants.forEach((r, index) => {
      console.log("ğŸ§ª restaurant raw data:", r);
      const card = document.createElement("div");
      card.className = "combo-card";

      const reasons = [];
      if (r.scoreDetail?.distanceScore > 0.7) {
        reasons.push("è·é›¢å¾ˆè¿‘");
      }

      if (r.scoreDetail?.preferenceScore > 0.6) {
        reasons.push("ç¬¦åˆä½ çš„é£²é£Ÿåå¥½");
      }

      if (reasons.length === 0) {
        reasons.push("æ•´é«”æ¢ä»¶å‡è¡¡");
      }

      card.innerHTML = `
        <div class="combo-body">
          <h3 class="combo-title">${r.name}</h3>

          <p class="combo-subtitle">
            æ¨è–¦åˆ†æ•¸ï¼š
            <strong>${(r.score * 100).toFixed(0)}%</strong>
          </p>

          <ul>
            <li>è·é›¢ä½ ç´„ ${r.distanceKm.toFixed(2)} å…¬é‡Œ</li>
            <li>æ¨è–¦åŸå› ï¼š${reasons.join("ã€")}</li>
          </ul>

          <div class="tags">
            <span>${r.amenity}</span>
            <span>å¤–é£Ÿ</span>
            <span>æ¨è–¦</span>
          </div>
        </div>
      `;

      resultsEl.appendChild(card);
    });

  }catch (err) {
    console.error("âŒ æ¨è–¦å¤±æ•—:", err);
    // â— ä¸é¡¯ç¤º alertï¼Œåªç•™ loadingï¼ˆé«”é©—æœƒå¥½å¾ˆå¤šï¼‰
    loadingEl.querySelector("p").textContent =
      "æ­£åœ¨ç‚ºä½ æ•´ç†æ¨è–¦ï¼Œè«‹ç¨å€™ä¸€ä¸‹ ğŸƒ";
  }
}

// âœ… é é¢ä¸€è¼‰å…¥å°±è·‘
loadRecommendations();
</script>

</body>
</html>